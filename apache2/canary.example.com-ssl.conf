<VirtualHost *:443>
    ServerName canary.example.com

    # SSL Configuration - Update paths to your certificate
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/canary.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/canary.example.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # CORS Headers
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

    # WebSocket Support - Upgrade WebSocket connections
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule ^/(.*) ws://localhost:4400/$1 [P,L]

    # Proxy Configuration
    ProxyPreserveHost On
    ProxyRequests Off

    # Handle WebSocket connections for ASR streaming
    ProxyPass /asr ws://localhost:4400/asr
    ProxyPassReverse /asr ws://localhost:4400/asr

    # Proxy all other requests to faster-whisper server
    ProxyPass / http://localhost:4400/
    ProxyPassReverse / http://localhost:4400/

    # Proxy timeout settings for audio processing
    ProxyTimeout 300
    ProxyBadHeader Ignore

    # Handle OPTIONS requests for CORS preflight
    <Location />
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ - [R=200,L]
    </Location>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/canary.example.com_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/canary.example.com_ssl_access.log combined
    LogLevel info ssl:warn
</VirtualHost>
